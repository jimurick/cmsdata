---
title: "R Notebook"
output:
html_notebook: default
---

All the zip files from the URL below were saved to the folder "zips". 
<https://data.cms.gov/provider-data/archived-data/hospitals>

The first code chunk gets a dataframe with one row for each unzipped folder. The `zip_date` column is used to identify the zip file.

```{r}
library(tidyverse)
library(lubridate)
Sys.setlocale("LC_TIME","English")
library(scales) # for a function or two in the last plot

parse_zip_dir <- function(zip_dir) {
  zip_re <- "(\\d{2})_(\\d{4})$"
  if (str_detect(zip_dir, zip_re)) {
    mo_year <- str_match(zip_dir, zip_re)[1, 2:3]
    tibble(
        zip_dir = zip_dir
      ) %>%
      mutate(
        zip_year = as.integer(mo_year[2]),
        zip_month = as.integer(mo_year[1]),
        zip_date = as_date(sprintf("%s-%s-01", mo_year[2], mo_year[1]))
      )
  }
}

# dataframe with one row per zip file
zip_df <- bind_rows(lapply(list.dirs("../zips"), parse_zip_dir)) %>%
  arrange(zip_date) %>%
  mutate(zip_id = 1:n()) %>%
  relocate(zip_id, .before = zip_dir)

```


There are 6 categories of input file in this notebook:

* `mort_readm`: Mortality and Readmission measures
* `hai`: HAI measures
* `hcahps`: HCAHPS measures
* `timely`: Timely and Effective Care measures
* `imaging`: Outpatient Imaging Efficiency measures
* `ipfqr`: The measure IMM-2 is in IPFQR Quality Measures file

The next 6 functions search a given unzipped folder for the relevant file(s). All functions return 1 file per unzipped folder, except `mort_readm` which may return 2.

```{r}

find_mort_readm_files <- function(zip_dir) {
  if (grepl("_10_2020$", zip_dir)) {
    file.path(zip_dir, c("ynj2-r877.csv", "632h-zaca.csv"))
  } else if (grepl("_07_2020$", zip_dir)) {
    file.path(zip_dir, c("pdc_s3_hos_data_ynj2_r877.csv",
                         "pdc_s3_hos_data_632h_zaca.csv"))
  } else {
    x <- list.files(zip_dir)
    death_readm_re <- "(hospital.*return|unplanned.*visit|and.*death).*hosp.*"
    x <- x[grepl(death_readm_re, x, ignore.case = TRUE)]
    file.path(zip_dir, x)
  }
}


find_hai_files <- function(zip_dir) {
  if (grepl("_10_2020$", zip_dir)) {
    file.path(zip_dir, "77hc-ibv8.csv")
  } else if (grepl("_07_2020$", zip_dir)) {
    file.path(zip_dir, "pdc_s3_hos_data_77hc_ibv8.csv")
  } else {
    x <- list.files(zip_dir)
    death_readm_re <- "^health.*assoc.*inf.*hosp.*"
    x <- x[grepl(death_readm_re, x, ignore.case = TRUE)]
    file.path(zip_dir, x)
  }
}

find_hcahps_files <- function(zip_dir) {
  if (grepl("_10_2020$", zip_dir)) {
    file.path(zip_dir, "dgck-syfz.csv")
  } else if (grepl("_07_2020$", zip_dir)) {
    file.path(zip_dir, "pdc_s3_hos_data_dgck_syfz.csv")
  } else {
    x <- list.files(zip_dir)
    hcahps_re <- "^hcahps.*hospital.*"
    x <- x[grepl(hcahps_re, x, ignore.case = TRUE)]
    file.path(zip_dir, x)
  }
}


find_timely_files <- function(zip_dir) {
  if (grepl("_10_2020$", zip_dir)) {
    file.path(zip_dir, "yv7e-xc69.csv")
  } else if (grepl("_07_2020$", zip_dir)) {
    file.path(zip_dir, "pdc_s3_hos_data_yv7e_xc69.csv")
  } else {
    x <- list.files(zip_dir)
    timely_re <- "^timely.*hospital.*"
    x <- x[grepl(timely_re, x, ignore.case = TRUE)]
    file.path(zip_dir, x)
  }
}


find_imaging_files <- function(zip_dir) {
  if (grepl("_10_2020$", zip_dir)) {
    file.path(zip_dir, "wkfw-kthe.csv")
  } else if (grepl("_07_2020$", zip_dir)) {
    file.path(zip_dir, "pdc_s3_hos_data_wkfw_kthe.csv")
  } else {
    x <- list.files(zip_dir)
    timely_re <- "imaging.*hospital.*"
    x <- x[grepl(timely_re, x, ignore.case = TRUE)]
    file.path(zip_dir, x)
  }
}


find_ipfqr_files <- function(zip_dir) {
  if (grepl("_10_2020$", zip_dir)) {
    file.path(zip_dir, "q9vs-r7wp.csv")
  } else if (grepl("_07_2020$", zip_dir)) {
    file.path(zip_dir, "pdc_s3_hos_data_q9vs_r7wp.csv")
  } else {
    x <- list.files(zip_dir)
    timely_re <- "ipfqr.*(hospital|facility).*"
    x <- x[grepl(timely_re, x, ignore.case = TRUE)]
    x <- x[!grepl("_FUH_", x)]
    file.path(zip_dir, x)
  }
}
```


This chunk initializes a bunch of constants that are used in the 6 functions that read in the data from the measure files.

```{r}
current_mort_codes <- c(
  'MORT_30_AMI', 'MORT_30_CABG', 'MORT_30_COPD',
  'MORT_30_HF', 'MORT_30_PN', 'MORT_30_STK', 'PSI_4_SURG_COMP'
)
current_readmission_codes <- c(
  'READM_30_HOSP_WIDE', 'READM_30_AMI', 'READM_30_CABG', 'READM_30_COPD',
  'READM_30_HF', 'READM_30_PN', 'READM_30_HIP_KNEE', 'EDAC_30_AMI',
  'EDAC_30_HF', 'EDAC_30_PN', 'OP_32', 'OP_35_ADM', 'OP_35_ED', 'OP_36'
)
old_mort_readm_codes <- c('COMP_HIP_KNEE', 'PSI_90', 'PSI_90_SAFETY', 'PSI_04')
current_mort_readm_codes <- c(current_mort_codes, current_readmission_codes,
                              old_mort_readm_codes)


current_hai_codes <- c('HAI_1', 'HAI_2', 'HAI_3', 'HAI_4', 'HAI_5', 'HAI_6')
latest_hai_filename <-
  zip_df %>%
  arrange(desc(zip_date)) %>%
  head(n=1) %>%
  mutate(filename = map(zip_dir, find_hai_files)) %>%
  unnest(filename) %>%
  pull(filename)
hai_measure_name_df <-
  read.csv(latest_hai_filename,
           colClasses = "character", check.names = FALSE) %>%
  select(measure_id = `Measure ID`, measure_name = `Measure Name`) %>%
  filter(grepl("_SIR$", measure_id)) %>%
  distinct() %>%
  mutate(measure_id = str_sub(measure_id, end = 5))


hcahps_measure_res <- str_c("H_", c("CLEAN(?:_HSP)?", str_c("COMP_", c(1:3,5:7)),
                                    "HSP_RATING", "QUIET(?:_HSP)?", "RECMND"))
hcahps_answers <- c("LINEAR_SCORE", "STAR_RATING", "SN_P", "U_P", "A_P",
                    "N_P", "Y_P", "D_SD", "A", "SA", "0_6", "7_8", "9_10",
                    "DN", "PY", "DY")
hcahps_filter_re <- str_c("^(", paste0(hcahps_measure_res, collapse = "|"), ")")
hcahps_answer_re <- str_c("^(", paste0(hcahps_measure_res, collapse = "|"), ")_(.*)")

latest_hcahps_filename <-
  zip_df %>%
  arrange(desc(zip_date)) %>%
  head(n=1) %>%
  mutate(filename = map(zip_dir, find_hcahps_files)) %>%
  unnest(filename) %>%
  pull(filename)
hcahps_measure_name_df <-
  read.csv(latest_hcahps_filename,
           colClasses = "character", check.names = FALSE) %>%
  filter(grepl("LINEAR_SCORE", `HCAHPS Measure ID`)) %>%
  select(
    measure_id = `HCAHPS Measure ID`,
    measure_name = `HCAHPS Question`
  ) %>%
  distinct(measure_id, measure_name) %>%
  transmute(
    measure_id = map_chr(measure_id, ~str_match(.x, "(.*)_LINEAR_SCORE")[2]),
    measure_id = ifelse(measure_id %in% c("H_CLEAN", "H_QUIET"),
                        str_c(measure_id, "_HSP"), measure_id),
    measure_name = map_chr(measure_name,
                           ~str_match(.x, "(.*) - linear mean score")[2])
  )


# Note: Didn't find 'ED_3' in any Timely files
timely_measures <- c(
  'OP_22', 'OP_29', 'IMM_3', 'OP_27', 'OP_23', 'PC_01',
  'SEP_1', 'OP_2', 'OP_3b', 'OP_18b', 'ED_3', 'OP_18c',
  'OP_30', 'ED_2B'
)
old_timely_measures <- c('OP_33')
timely_measure_df <-
  tibble(measure_re0 = c(timely_measures, old_timely_measures), dummy = 1) %>%
  mutate(
    measure_re = map_chr(measure_re0, ~str_c(toupper(.x), "($|_)")),
    measure_match = map_chr(measure_re0, ~str_c("(", toupper(.x), ")($|_.*$)"))
  )

imaging_measure_ids <- c("OP_8", "OP_10", "OP_13")
```



These 6 functions read the 6 types of measure files. They all take a filename as an argument, and they also use variables in the global environment that were created in the previous code chunk.

```{r}

read_mort_readm_data <- function(filename) {
  df <- read.csv(filename, check.names = FALSE, colClasses = "character")
  colnames(df)[1:2] <- c("provider_id", "hospital_name")
  x <- which(grepl("(start|end) date", colnames(df), ignore.case = TRUE))
  colnames(df)[x] <- c("measure_start_date", "measure_end_date")
  
  df %>%
    mutate(across(everything(), str_trim)) %>%
    transmute(
      provider_id,
      hospital_name,
      measure_id = `Measure ID`,
      measure_name = `Measure Name`,
      score = ifelse(Score == "Not Available", NA_character_, Score),
      score = as.numeric(score),
      score = case_when(
        grepl("^(EDAC|PSI|OP)_", measure_id) ~ score,
        TRUE                        ~ score / 100
      ),
      denominator =
        ifelse(Denominator == "Not Available", NA_character_, Denominator),
      denominator = as.integer(denominator),
      compared_to_national = `Compared to National`,
      measure_start_date =
        lubridate::as_date(measure_start_date, format = "%m/%d/%Y"),
      measure_end_date =
        lubridate::as_date(measure_end_date, format = "%m/%d/%Y")
    ) %>%
    filter(toupper(measure_id) %in% toupper(current_mort_readm_codes))
}



read_hai_corrected_data <- function(foldername, quarter_pattern = "") {
  all_files <- list.files(foldername)
  file_re <- sprintf("^corrected_hai_.*%s.*fac.*.csv", quarter_pattern)
  corr_files <-
    all_files[grepl(file_re, all_files, ignore.case = TRUE)]
  hai_abbreviation_df <-
    tibble(
      abbreviation = c("cauti", "cdiff", "clabsi"),
      measure_id = c("HAI_2", "HAI_6", "HAI_1")
    )
  
  read_data <- function(fn) {
    df <- read.csv(fn, check.names = FALSE, colClasses = "character")
    colnames(df) <- c("provider_id", "numerator", "elig_cases", "sir",
                      "ci_lower", "ci_upper", "compared_to_national", "dopc")
    df
  }
  
  tibble(filename = file.path(foldername, corr_files)) %>%
    mutate(
      abbreviation = map_chr(
        filename, ~str_match(.x, "corrected_hai_([^_]+)_")[1,2]
      )
    ) %>%
    left_join(hai_abbreviation_df, by = "abbreviation") %>%
    mutate(
      data = map(filename, read_data)
    ) %>%
    select(measure_id, data) %>%
    unnest(data) %>%
    mutate(across(everything(), str_trim)) %>%
    mutate(
      across(
        all_of(c("numerator", "elig_cases", "sir",
                 "ci_lower", "ci_upper", "dopc")),
        function(x) ifelse(grepl("^[-0-9.]+$", x), x, NA_character_)
      )
    ) %>%
    mutate(
      compared_to_national = ifelse(compared_to_national == "N/A",
                                    NA_character_, compared_to_national),
      across(all_of(c("numerator", "dopc")), as.integer),
      across(all_of(c("sir", "ci_lower", "ci_upper", "elig_cases")), as.numeric)
    )
}


read_hai_data <- function(filename, hai_measure_name_df) {
  df <- read.csv(filename, check.names = FALSE, colClasses = "character")
  colnames(df)[1:2] <- c("provider_id", "hospital_name")
  x <- which(grepl("(start|end) date", colnames(df), ignore.case = TRUE))
  colnames(df)[x] <- c("measure_start_date", "measure_end_date")
  
  df <-
    df %>%
    mutate(across(everything(), str_trim)) %>%
    filter(grepl("^HAI[-_][1-6][-_]", `Measure ID`)) %>%
    transmute(
      provider_id,
      hospital_name,
      measure_id = gsub('-', '_', toupper(`Measure ID`)),
      measure_stat = map_chr(measure_id, ~str_sub(.x, start = nchar("HAI_n_")+1)),
      measure_id   = map_chr(measure_id, ~str_sub(.x, end   = nchar("HAI_n"))),
      measure_stat = tolower(measure_stat),
      measure_stat = case_when(
        measure_stat %in% c("ci_lower", "cilower")     ~ "ci_lower",
        measure_stat %in% c("ci_upper", "ciupper")     ~ "ci_upper",
        measure_stat %in% c("dopc_days", "dopc")       ~ "dopc",
        measure_stat %in% c("elig_cases", "eligcases") ~ "elig_cases",
        TRUE                                           ~ measure_stat
      ),
      score = ifelse(!grepl("^-?[0-9.]+$", Score), NA_character_, Score),
      score = as.numeric(score),
      compared_to_national = `Compared to National`,
      measure_start_date =
        lubridate::as_date(measure_start_date, format = "%m/%d/%Y"),
      measure_end_date =
        lubridate::as_date(measure_end_date, format = "%m/%d/%Y")
    )
  
  df <-
    df %>%
    select(-compared_to_national) %>%
    pivot_wider(names_from = measure_stat, values_from = score) %>%
    left_join(
      df %>% filter(replace_na(compared_to_national,'') != '') %>%
        distinct(provider_id, measure_id, compared_to_national),
      by = c("provider_id", "measure_id")
    )
  
  if (grepl("_(11_2016|12_2016|04_2017|07_2017)$", dirname(filename))) {
    foldername <- dirname(filename)
    quarter_pattern <- ""
    if (grepl("_12_2016$", foldername)) {
      quarter_pattern <- "2015Q2-2016Q1"
      manual_start_date <- lubridate::as_date("2015-04-01")
      manual_end_date   <- lubridate::as_date("2016-03-31")
    }
    if (grepl("_11_2016$", foldername)) {
      foldername <- gsub("_11_2016", "_12_2016", foldername)
      quarter_pattern <- "2015Q1-2015Q4"
      manual_start_date <- lubridate::as_date("2015-01-01")
      manual_end_date   <- lubridate::as_date("2015-12-31")
    }
    update_df <- read_hai_corrected_data(foldername, quarter_pattern)
    new_records_df <- df %>%
      select(-sir, -numerator, -elig_cases, -dopc,
             -ci_lower, -ci_upper, -compared_to_national) %>%
      inner_join(update_df, by = c("provider_id", "measure_id"))
    df <-
      bind_rows(
        df %>% anti_join(update_df, by = c("provider_id", "measure_id")),
        new_records_df
      )
    if (quarter_pattern != "") {
      df$measure_start_date <- manual_start_date
      df$measure_end_date   <- manual_end_date
    }
  }
  
  df %>%
    select(provider_id, hospital_name, measure_id,
           sir, numerator, elig_cases, dopc, ci_lower, ci_upper,
           compared_to_national, measure_start_date, measure_end_date) %>%
    mutate(numerator = as.integer(numerator), dopc = as.integer(dopc)) %>%
    inner_join(hai_measure_name_df, by = "measure_id")
}



read_hcahps_data <- function(filename, hcahps_measure_name_df) {
  df <- read.csv(filename, check.names = FALSE, colClasses = "character")
  colnames(df)[1:2] <- c("provider_id", "hospital_name")
  x <- which(grepl("(start|end) date", colnames(df), ignore.case = TRUE))
  colnames(df)[x] <- c("measure_start_date", "measure_end_date")
  x <- which(grepl("(star rating$|linear mean)", colnames(df), ignore.case = TRUE))
  if (length(x) == 2) {
    colnames(df)[x] <- c("star_rating", "linear_mean_score")
  } else {
    df$star_rating <- NA_character_
    df$linear_mean_score <- NA_character_
  }
  
  df <-
    df %>%
    select(
      provider_id,
      full_measure_id = `HCAHPS Measure ID`,
      answer_percent = `HCAHPS Answer Percent`,
      linear_mean_score,
      star_rating,
      completed_surveys = `Number of Completed Surveys`,
      measure_start_date,
      measure_end_date
    ) %>%
    mutate(across(everything(), str_trim)) %>%
    filter(grepl(hcahps_filter_re, full_measure_id)) %>%
    mutate(
      measure_id = map_chr(full_measure_id, ~str_match(.x, hcahps_answer_re)[, 2]),
      answer_id  = map_chr(full_measure_id, ~str_match(.x, hcahps_answer_re)[, 3]),
      measure_id = ifelse(measure_id %in% c("H_CLEAN", "H_QUIET"),
                          str_c(measure_id, "_HSP"), measure_id),
      answer_percent = case_when(
        answer_id == "LINEAR_SCORE" ~ linear_mean_score,
        answer_id == "STAR_RATING"  ~ star_rating,
        TRUE                        ~ answer_percent
      ),
      answer_percent = ifelse(grepl("[^0-9.-]", answer_percent),
                              NA_character_, answer_percent),
      answer_percent = as.numeric(answer_percent),
      completed_surveys = ifelse(grepl("[^0-9.-]", completed_surveys),
                              NA_character_, completed_surveys),
      completed_surveys = as.integer(completed_surveys),
      measure_start_date =
        lubridate::as_date(measure_start_date, format = "%m/%d/%Y"),
      measure_end_date =
        lubridate::as_date(measure_end_date, format = "%m/%d/%Y")
    ) %>%
    select(
      measure_id, answer_id, provider_id, answer_percent,
      completed_surveys, measure_start_date, measure_end_date
    ) %>%
    pivot_wider(names_from = answer_id, values_from = answer_percent)
  
  missing_answers <- setdiff(hcahps_answers, colnames(df))
  if (length(missing_answers) > 0) {
    df[, missing_answers] <- NA_real_
  }
  df %>%
    left_join(hcahps_measure_name_df, by = "measure_id") %>%
    select_at(c("provider_id", "measure_id", "measure_name",
                hcahps_answers, "completed_surveys",
                "measure_start_date", "measure_end_date"))
}


read_timely_data <- function(filename) {
  df <- read.csv(filename, check.names = FALSE, colClasses = "character")
  
  colnames(df)[1:2] <- c("provider_id", "hospital_name")
  x <- which(grepl("(start|end) date", colnames(df), ignore.case = TRUE))
  colnames(df)[x] <- c("measure_start_date", "measure_end_date")
  
  measure_label_df <-
    df %>%
    transmute(measure_id = `Measure ID`, dummy = 1) %>%
    distinct() %>%
    inner_join(timely_measure_df, by = "dummy") %>%
    mutate(
      matched_list = map2_int(measure_re, measure_id, ~grepl(.x, toupper(.y)))
    ) %>%
    filter(matched_list == 1) %>%
    mutate(
      measure_id2 = map2_chr(measure_id, measure_match, ~str_match(.x, .y)[1, 2]),
      measure_label = case_when(
        toupper(measure_id2) %in% c("IMM_3","OP_27") ~ "IMM-3/OP-27",
        toupper(measure_id2) %in% c("OP_18B","ED_3") ~ "OP-18b/ED-3",
        TRUE                                         ~ gsub("_", "-", measure_id2)
      )
    ) %>%
    select(measure_id, measure_label)
  
  df %>%
    transmute(
      provider_id,
      hospital_name,
      condition = Condition,
      measure_id = `Measure ID`,
      measure_name = `Measure Name`,
      score = Score,
      sample = Sample,
      measure_start_date,
      measure_end_date
    ) %>%
    mutate(across(everything(), str_trim)) %>%
    inner_join(measure_label_df, by = "measure_id") %>%
    mutate(
      score  = ifelse(grepl("[^0-9.-]", score), NA_character_, score),
      sample = ifelse(grepl("[^0-9.-]", sample), NA_character_, sample),
      score  = as.numeric(score),
      score = case_when(
        toupper(measure_id) %in% c("ED_2B", "OP_18B", "OP_3B") ~ score,
        TRUE ~ score / 100
      ),
      sample = as.integer(sample),
      measure_start_date =
        lubridate::as_date(measure_start_date, format = "%m/%d/%Y"),
      measure_end_date =
        lubridate::as_date(measure_end_date, format = "%m/%d/%Y")
    )
}


read_imaging_data <- function(filename) {
  df <- read.csv(filename, check.names = FALSE, colClasses = "character")
  colnames(df)[1:2] <- c("provider_id", "hospital_name")
  x <- which(grepl("(start|end) date", colnames(df), ignore.case = TRUE))
  colnames(df)[x] <- c("measure_start_date", "measure_end_date")
  df %>%
    mutate(across(everything(), str_trim)) %>%
    transmute(
      provider_id,
      hospital_name,
      measure_id = gsub("-", "_", `Measure ID`),
      measure_name = `Measure Name`,
      score  = ifelse(grepl("[^0-9.-]", Score), NA_character_, Score),
      score  = as.numeric(score) / 100,
      measure_start_date =
        lubridate::as_date(measure_start_date, format = "%m/%d/%Y"),
      measure_end_date =
        lubridate::as_date(measure_end_date, format = "%m/%d/%Y")
    ) %>%
    filter(toupper(measure_id) %in% imaging_measure_ids)
}


read_ipfqr_data <- function(filename) {
  df <-
    read.csv(filename, colClasses = "character", check.names = FALSE)
  
  colnames(df)[1:2] <- c("provider_id", "hospital_name")
  df <-
    df %>%
    pivot_longer(all_of(colnames(df)[3:ncol(df)]),
                 names_to = "label", values_to = "value") %>%
    mutate(
      imm_2_column = grepl("^imm[-_]2", label, ignore.case = TRUE),
      date_column  = grepl("flu.*(start|end).date", label, ignore.case = TRUE)
    ) %>%
    filter(imm_2_column | date_column) %>%
    mutate(
      measure_id = "IMM_2",
      imm_label = map2_chr(label, measure_id, ~str_sub(.x, start = nchar(.y)+2)),
      date_label = ifelse(grepl("flu.*start.date", label, ignore.case = TRUE),
                          "measure_start_date", "measure_end_date"),
      label = ifelse(imm_2_column, imm_label, date_label)
    ) %>%
    select(-imm_2_column, -date_column, -imm_label, -date_label) %>%
    mutate(across(everything(), str_trim)) %>%
    mutate(
      label = case_when(
        label == "%" ~ "score",
        grepl("measure.desc", tolower(label)) ~ "measure_name",
        TRUE ~ tolower(gsub("[ -]", "_", label))
      )
    ) %>%
    filter(label %in% c("measure_name", "score", "denominator",
                        "measure_start_date", "measure_end_date"))
  
  if (nrow(df) > 0) {
    df %>%
      pivot_wider(names_from = label, values_from = value) %>%
      mutate(
        score = gsub("%", "", score),
        score = ifelse(grepl("[^0-9.]", score), NA_character_, score),
        denominator =
          ifelse(grepl("[^0-9]", denominator), NA_character_, denominator),
        score = as.numeric(score),
        denominator = as.integer(denominator),
        measure_start_date =
          lubridate::as_date(measure_start_date, format = "%m/%d/%Y"),
        measure_end_date =
          lubridate::as_date(measure_end_date, format = "%m/%d/%Y")
      )
  }
}
```


This code chunk actually the 12 functions above to find the measure files and read/process their data into dataframes saved in list columns named `data`.

```{r}
all_mort_readm_data_df <-
  zip_df %>%
  mutate(filename = map(zip_dir, find_mort_readm_files)) %>%
  unnest(filename) %>%
  mutate(data = map(filename, read_mort_readm_data))

all_hai_data_df <-
  zip_df %>%
  mutate(filename = map(zip_dir, find_hai_files)) %>%
  unnest(filename) %>%
  mutate(data = map(filename, read_hai_data, hai_measure_name_df))

all_hcahps_data_df <-
  zip_df %>%
  mutate(filename = map(zip_dir, find_hcahps_files)) %>%
  unnest(filename) %>%
  mutate(data = map(filename, read_hcahps_data, hcahps_measure_name_df))

all_timely_data_df <-
  zip_df %>%
  mutate(filename = map(zip_dir, find_timely_files)) %>%
  unnest(filename) %>%
  mutate(data = map(filename, read_timely_data))

all_imaging_data_df <-
  zip_df %>%
  mutate(filename = map(zip_dir, find_imaging_files)) %>%
  unnest(filename) %>%
  mutate(data = map(filename, read_imaging_data))

all_ipfqr_data_df <-
  zip_df %>%
  mutate(filename = map(zip_dir, find_ipfqr_files)) %>%
  unnest(filename) %>%
  mutate(data = map(filename, read_ipfqr_data))
```


```{r}
read_general_info_file <- function(zip_dir, zip_date) {
  if (zip_date == "2020-07-01") {
    fname <- file.path(zip_dir, "pdc_s3_hos_data_xubh_q36u.csv")
  } else if (zip_date == "2020-10-01") {
    fname <- file.path(zip_dir, "xubh-q36u.csv")
  } else {
    fname <- list.files(zip_dir, pattern = "Hospital.*General.*Information.csv")
    fname <- file.path(zip_dir, fname)
  }
  read.csv(fname, colClasses = "character", check.names = FALSE) %>%
    mutate(across(everything(), str_trim))
}

read_va_hospital_file <- function(zip_dir, zip_date) {
  if (zip_date == "2020-07-01") {
    fname <- "pdc_s3_hos_data_uyx4_5s7f.csv"
  } else if (zip_date == "2020-10-01") {
    fname <- "uyx4-5s7f.csv"
  } else {
    fname <- list.files(zip_dir, pattern = "Vet.*Health.*Admin.*Prov.*.csv")
  }
  if (length(fname) > 0) {
    fname <- file.path(zip_dir, fname)
    if (file.exists(fname)) {
      read.csv(fname, colClasses = "character", check.names = FALSE) %>%
        mutate(across(everything(), str_trim))
    }
  }
}



va_hospital_df <-
  zip_df %>%
  transmute(
    zip_id,
    zip_date,
    va_df = map2(zip_dir, zip_date, read_va_hospital_file),
    va_df_null = map_int(va_df, ~is.null(.x))
  ) %>%
  filter(!va_df_null) %>%
  select(-va_df_null)


all_info_df <-
  zip_df %>%
  transmute(
    zip_id,
    zip_date,
    info_df = map2(zip_dir, zip_date, read_general_info_file)
  ) %>%
  arrange(zip_date)



just_get_rating <- function(df) {
  rating_col <- "Hospital overall rating"
  if (rating_col %in% colnames(df)) {
    df <-
      df %>%
      select_at(c(colnames(df)[1], rating_col))
    colnames(df) <- c("provider_id", "stars")
    df %>%
      mutate(
        stars = ifelse(stars == "Not Available", NA_character_, stars),
        stars = as.integer(stars)
      )
  }
}

all_star_ratings_df <-
  all_info_df %>%
  mutate(rating_df = map(info_df, just_get_rating)) %>%
  select(-info_df) %>%
  unnest(rating_df)

all_star_ratings_df %>%
  mutate(zip_id = zip_id + 1, prev_stars = stars) %>%
  select(-zip_date, -stars) %>%
  inner_join(all_star_ratings_df, by = c("zip_id", "provider_id")) %>%
  mutate(same = (prev_stars == stars)) %>%
  group_by(zip_date) %>%
  summarize(
    sames = sum(same, na.rm = TRUE),
    differents = sum(!same, na.rm = TRUE),
    nas = sum(is.na(same)),
    .groups = "drop"
  )

va_hospital_df %>%
  mutate(va_df = map(va_df, ~tibble(provider_id = .x[, colnames(.x)[1]]))) %>%
  unnest(va_df) %>%
  count(provider_id) %>%
  count(n, name = "nn")
  
```





Count the total number of rows in each table

```{r}
all_mort_readm_data_df %>% select(zip_date, data) %>% unnest(data) # 2,453,750
all_hai_data_df %>% select(zip_date, data) %>% unnest(data)        #   859,722
all_hcahps_data_df %>% select(zip_date, data) %>% unnest(data)     # 1,442,800
all_timely_data_df %>% select(zip_date, data) %>% unnest(data)     # 1,308,370
all_imaging_data_df %>% select(zip_date, data) %>% unnest(data)    #   414,480
all_ipfqr_data_df %>%
  transmute(zip_date, data, data_exists = !map_lgl(data, is.null)) %>%
  filter(data_exists) %>% select(zip_date, data) %>% unnest(data)  #    35,587

# 6028 hospital IDs
all_mort_readm_data_df %>% select(zip_date, data) %>% unnest(data) %>%
  distinct(provider_id)
```


Count the number of rows in each dataframe

```{r}
all_mort_readm_data_df %>% transmute(zip_date, map_int(data, nrow), filename)
all_hai_data_df %>% transmute(zip_date, map_int(data, nrow), filename)
all_hcahps_data_df %>% transmute(zip_date, map_int(data, nrow), filename)
all_timely_data_df %>% transmute(zip_date, map_int(data, nrow), filename)
all_imaging_data_df %>% transmute(zip_date, map_int(data, nrow), filename)
all_ipfqr_data_df %>%
  transmute(zip_date, data, filename, data_exists = !map_lgl(data, is.null)) %>%
  filter(data_exists) %>%
  transmute(zip_date, map_int(data, nrow), filename) %>% arrange(zip_date)
```



Make a Geisinger-only copy of each table

```{r}
geis_hospital_df <-
  tibble(
    provider_id = c('390001', '390003', '390006', '390048', '390270', '391300'),
    hospital_name = c(
      'GEISINGER-COMMUNITY MEDICAL CENTER', 'GEISINGER-BLOOMSBURG HOSPITAL',
      'GEISINGER MEDICAL CENTER', 'GEISINGER-LEWISTOWN HOSPITAL',
      'GEISINGER WYOMING VALLEY MEDICAL CENTER', 'GEISINGER JERSEY SHORE HOSPITAL'
    ),
    short_name = c(
      'GCMC', 'Bloomsburg', 'GMC', 'Lewistown', 'GWV', 'Jersey Shore'
    )
  )

geis_mort_readm_data_df <-
  all_mort_readm_data_df %>%
  select(zip_date, data) %>%
  unnest(data) %>%
  select(-hospital_name) %>%
  inner_join(geis_hospital_df, by = "provider_id") %>%
  mutate(
    measure_label = gsub("_", "-", measure_id),
    axis_label = "Score"
  )
  
geis_hai_data_df <-
  all_hai_data_df %>%
  select(zip_date, data) %>%
  unnest(data) %>%
  select(-hospital_name) %>%
  inner_join(geis_hospital_df, by = "provider_id") %>%
  rename(score = sir) %>%
  mutate(
    measure_label = gsub("_", "-", measure_id),
    axis_label = "SIR"
  )

geis_hcahps_data_df <-
  all_hcahps_data_df %>%
  select(zip_date, data) %>%
  unnest(data) %>%
  inner_join(geis_hospital_df, by = "provider_id") %>%
  rename(score = LINEAR_SCORE, star_rating = STAR_RATING) %>%
  mutate(
    measure_label = gsub("_", "-", measure_id),
    axis_label = "Linear Mean Score (%)"
  )

geis_timely_data_df <-
  all_timely_data_df %>%
  select(zip_date, data) %>%
  unnest(data) %>%
  select(-hospital_name) %>%
  inner_join(geis_hospital_df, by = "provider_id") %>%
  mutate(
    axis_label = ""
  )

geis_imaging_data_df <-
  all_imaging_data_df %>%
  select(zip_date, data) %>%
  unnest(data) %>%
  select(-hospital_name) %>%
  inner_join(geis_hospital_df, by = "provider_id") %>%
  mutate(
    measure_label = gsub("_", "-", measure_id),
    axis_label = ""
  )

geis_ipfqr_data_df <-
  all_ipfqr_data_df %>%
  transmute(zip_date, data, data_exists = !map_lgl(data, is.null)) %>%
  filter(data_exists) %>%
  select(zip_date, data) %>%
  unnest(data) %>%
  select(-hospital_name) %>%
  inner_join(geis_hospital_df, by = "provider_id") %>%
  mutate(
    measure_label = gsub("_", "-", measure_id),
    axis_label = "?"
  )
```



Combine the Geisinger tables

```{r}
# This is the first two columns from the "Measure Tables" tab of
# "Reference for Measure Tables and Formatting.xlsx"
measure_group_df <- read.csv("measure_groups.csv", colClasses = "character")

all_geis_data <-
  bind_rows(
    geis_mort_readm_data_df, geis_hai_data_df, geis_hcahps_data_df,
    geis_timely_data_df, geis_imaging_data_df, geis_ipfqr_data_df
  ) %>%
  left_join(measure_group_df, by = "measure_label") %>%
  select_at(
    c(
      "zip_date", "provider_id", "hospital_name", "short_name",
      "measure_group", "measure_label", "measure_id", "measure_name",
      "measure_start_date", "measure_end_date",
      "score", "axis_label",
      "compared_to_national", "denominator",
      "numerator", "elig_cases", "dopc", "ci_upper", "ci_lower",
      "condition", "sample", "star_rating", "completed_surveys",
      hcahps_answers[3:length(hcahps_answers)]
    )
  )

all_geis_data
```


```{r}
library(openxlsx)
write.xlsx(all_geis_data, "Care Compare Data - Geisinger 2022-04-15.xlsx")
```




```{r}
last_zip_dir <- zip_df %>% arrange(desc(zip_date)) %>% head(1) %>% pull(zip_dir)
all_files <- list.files(last_zip_dir)
general_info_filename <-
  file.path(last_zip_dir, all_files[grepl("hospital.*general.*info.*.csv$",
                                          all_files, ignore.case = TRUE)])

df <- read.csv(general_info_filename, check.names = FALSE)

#colnames(df)
count_col_re <- "Count of Facility (.*) Measures"
count_cols <-
  colnames(df)[grepl(count_col_re, colnames(df), ignore.case = TRUE)]
count_short_names <-
  tolower(gsub(" ", "_", str_match(count_cols, count_col_re)[, 2]))

convert_col_to_int <- function(x) {
  as.integer(ifelse(grepl("^[0-9]+$", x), x, NA_character_))
}

domain_count_df <- df %>%
  select_at(c("Facility ID", "State", count_cols)) %>%
  mutate(across(all_of(count_cols), convert_col_to_int))
colnames(domain_count_df) <-
  c("provider_id", "state", str_c(count_short_names, "_count"))
for (cname in count_short_names) {
  domain_count_df[[cname]] <-
    replace_na(domain_count_df[[str_c(cname, "_count")]] >= 3, FALSE)
}
domain_count_df$domain_count <- rowSums(domain_count_df[, count_short_names])
domain_count_df <- domain_count_df %>%
  mutate(count_group = ifelse((mort | safety) & (domain_count >= 3),
                              domain_count, NA_integer_)) %>%
  relocate(count_group, .after = state)

domain_count_df
```

```{r}
save(all_hai_data_df, file = "Example - HAI-1/all_hai_data.RData")
#save(domain_count_df, file = "Example - HAI-1/domain_count_df.RData")
```





```{r}
all_hai_data_df %>% filter(zip_date == "2016-11-01") %>% pull(data) %>% `[[`(1) %>%
  arrange(provider_id, measure_id)
all_hai_data_df %>% filter(zip_date == "2016-12-01") %>% pull(data) %>% `[[`(1) %>%
  arrange(provider_id, measure_id)
```




